# ğŸ”„ Complete Flow: From Lead to Conversation

## ğŸ“‹ Step-by-Step Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: CREATE A LEAD                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  You click "Create Lead"        â”‚
        â”‚  Fill in: Name, Email, etc.     â”‚
        â”‚  Click "Create Lead" button     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Lead is saved to DATABASE      â”‚
        â”‚  âœ… Lead ID: 123                 â”‚
        â”‚  âœ… Name: "John Doe"              â”‚
        â”‚  âœ… Email: "john@example.com"    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Lead appears in LEADS TAB      â”‚
        â”‚  âœ… You can see it immediately   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  âŒ NO CONVERSATION YET          â”‚
        â”‚  (No message exists)             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              STEP 2: MESSAGE CREATION                   â”‚
        â”‚  (This is where conversations come from!)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  ğŸ”€ THREE WAYS A MESSAGE CAN BE CREATED:                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚
        â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  METHOD 1:        â”‚            â”‚  METHOD 2:        â”‚
â”‚  AUTOMATION       â”‚            â”‚  MANUAL SEND      â”‚
â”‚  (Automatic)      â”‚            â”‚  (You do it)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                   â”‚
        â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend detects  â”‚            â”‚  You send email/  â”‚
â”‚  new lead created  â”‚            â”‚  SMS to the lead  â”‚
â”‚                   â”‚            â”‚                   â”‚
â”‚  Automation       â”‚            â”‚  You click "Send  â”‚
â”‚  triggers         â”‚            â”‚  Message" button  â”‚
â”‚                   â”‚            â”‚                   â”‚
â”‚  Sends welcome    â”‚            â”‚  Message is sent  â”‚
â”‚  email            â”‚            â”‚  via API          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  MESSAGE IS CREATED IN DATABASE â”‚
        â”‚  âœ… Message ID: 456              â”‚
        â”‚  âœ… Lead ID: 123 (linked)        â”‚
        â”‚  âœ… Channel: "email"              â”‚
        â”‚  âœ… Direction: "outbound"         â”‚
        â”‚  âœ… Content: "Welcome email..."   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  CONVERSATION IS CREATED         â”‚
        â”‚  (Built from messages)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Conversation appears in         â”‚
        â”‚  CONVERSATIONS TAB               â”‚
        â”‚  âœ… You can see it now!          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Detailed Explanation

### **STEP 1: Create a Lead**

**What happens:**
1. You fill in the form (name, email, etc.)
2. Click "Create Lead"
3. Frontend calls `api.createLead()`
4. Backend saves to database
5. Lead appears in **Leads Tab**

**At this point:**
- âœ… Lead exists in database
- âœ… Lead appears in Leads Tab
- âŒ NO message exists yet
- âŒ NO conversation exists yet

---

### **STEP 2: Message Creation (THE KEY STEP!)**

**This is where conversations come from!**

A message can be created in **3 ways**:

#### **METHOD 1: Automation (Automatic)**

**What happens:**
1. Backend detects: "New lead created!"
2. Looks for automation with trigger: `new_lead`
3. Finds "Welcome New Leads" automation
4. Automation executes:
   - Sends email to the lead
   - **Creates a message record in database**
5. Message is created â†’ Conversation appears!

**Where this happens:**
- **Backend code**: `backend/automations/services.py`
- **Function**: `trigger_automations('new_lead', context)`
- **When**: Immediately after lead creation (or after delay)

**Code flow:**
```
Lead created â†’ Django signal fires â†’ trigger_automations() â†’ 
AutomationExecutor.execute() â†’ Send email â†’ Create Message â†’ 
Conversation appears
```

---

#### **METHOD 2: Manual Send (You do it)**

**What happens:**
1. You create lead with "Send follow-up email" checked
2. OR you go to Conversations tab and send a message
3. Frontend calls `api.sendMessage()`
4. Backend:
   - Sends the email/SMS
   - **Creates a message record in database**
5. Message is created â†’ Conversation appears!

**Where this happens:**
- **Frontend**: `app/leads/page.tsx` â†’ `handleCreateLead()`
- **API**: `lib/api.ts` â†’ `sendMessage()`
- **Backend**: `backend/messages/views.py` â†’ `MessageListCreateView`

**Code flow:**
```
You click "Send" â†’ api.sendMessage() â†’ Backend API â†’ 
Create Message in database â†’ Conversation appears
```

---

#### **METHOD 3: Inbound Message (Lead contacts you)**

**What happens:**
1. Lead sends you an email/SMS
2. Backend receives it (webhook or polling)
3. Backend:
   - Processes the message
   - **Creates a message record in database**
4. Message is created â†’ Conversation appears!

**Where this happens:**
- **Backend**: `backend/messages/services.py` â†’ `process_inbound_message()`

---

### **STEP 3: Conversation Creation**

**What happens:**
1. Message exists in database (from Step 2)
2. Frontend fetches messages: `api.getMessages()`
3. Frontend groups messages by lead + channel
4. Creates conversation objects
5. Displays in **Conversations Tab**

**Where this happens:**
- **Frontend**: `app/conversations/page.tsx` â†’ `fetchData()`
- **Function**: Groups messages into conversations

**Code:**
```typescript
// Group messages by lead and channel
messages.forEach((message) => {
  const leadId = message.leadId;
  const key = `${leadId}-${message.channel}`;
  
  // Create conversation if it doesn't exist
  if (!conversationsMap.has(key)) {
    conversationsMap.set(key, {
      lead: lead,
      messages: [message],
      lastMessage: message,
      channel: message.channel
    });
  }
});
```

---

## ğŸ” Where Messages Are Created (Database)

### **Database Table: `messages_message`**

**Structure:**
```sql
CREATE TABLE messages_message (
    id INTEGER PRIMARY KEY,
    lead_id INTEGER,           -- Links to lead
    channel VARCHAR,            -- 'email', 'sms', etc.
    direction VARCHAR,          -- 'inbound' or 'outbound'
    content TEXT,               -- Message text
    timestamp DATETIME,         -- When sent/received
    ...
);
```

**When a message is created:**
- âœ… Record is inserted into `messages_message` table
- âœ… `lead_id` links it to the lead
- âœ… Frontend fetches this table to build conversations

---

## ğŸ“Š Complete Example Flow

### **Scenario: You create a lead named "Sarah"**

```
1. YOU CREATE LEAD
   â”œâ”€ Frontend: app/leads/page.tsx â†’ handleCreateLead()
   â”œâ”€ API: lib/api.ts â†’ createLead()
   â”œâ”€ Backend: backend/leads/views.py â†’ LeadListCreateView
   â””â”€ Database: INSERT INTO leads_lead (name, email, ...)
   
   Result: âœ… Lead "Sarah" in database
   Result: âœ… Lead "Sarah" appears in Leads Tab
   Result: âŒ NO conversation yet (no message)

2. AUTOMATION TRIGGERS (Automatic)
   â”œâ”€ Backend: Django signal fires
   â”œâ”€ Backend: automations/services.py â†’ trigger_automations('new_lead')
   â”œâ”€ Backend: AutomationExecutor.execute()
   â”œâ”€ Backend: Sends email to sarah@example.com
   â”œâ”€ Backend: messages/views.py â†’ Creates message record
   â””â”€ Database: INSERT INTO messages_message (lead_id, content, ...)
   
   Result: âœ… Message created in database
   Result: âœ… Message linked to lead "Sarah"

3. FRONTEND FETCHES MESSAGES
   â”œâ”€ Frontend: app/conversations/page.tsx â†’ fetchData()
   â”œâ”€ API: lib/api.ts â†’ getMessages()
   â”œâ”€ Backend: backend/messages/views.py â†’ MessageListCreateView
   â””â”€ Frontend: Groups messages into conversations
   
   Result: âœ… Conversation appears in Conversations Tab
   Result: âœ… You can see "Sarah" with the welcome email
```

---

## ğŸ¯ Key Points to Remember

### **1. Messages are created in the DATABASE**
- Not in the frontend
- Backend creates them
- Stored in `messages_message` table

### **2. Conversations are built from MESSAGES**
- Frontend fetches messages
- Groups them by lead + channel
- Displays as conversations

### **3. Three ways messages are created:**
1. **Automation** (automatic) - Most common
2. **Manual send** (you do it)
3. **Inbound** (lead contacts you)

### **4. The flow is:**
```
Lead Created â†’ Message Created â†’ Conversation Appears
     âœ…              âœ…                    âœ…
```

---

## â“ Common Questions

### **Q: Where exactly is the message created?**
**A:** In the backend, in the `messages_message` database table. The backend code creates it when:
- Automation runs
- You send a message via API
- Inbound message is received

### **Q: Why doesn't my lead show in Conversations?**
**A:** Because no message exists yet. Check:
1. Is automation enabled? (Settings â†’ Automations)
2. Did automation run? (Check backend logs)
3. Did you send a message manually?

### **Q: How do I make a conversation appear?**
**A:** Create a message! Either:
1. Wait for automation to send welcome email
2. Send a follow-up email when creating lead
3. Manually send a message from Conversations tab

---

## âœ… Summary

**The Complete Flow:**
1. **Create Lead** â†’ Saved to database â†’ Appears in Leads Tab
2. **Message Created** â†’ By automation, manual send, or inbound
3. **Conversation Built** â†’ Frontend groups messages by lead
4. **Conversation Appears** â†’ Shows in Conversations Tab

**Remember:**
- Leads = People (in Leads Tab)
- Messages = Communication records (in database)
- Conversations = Grouped messages (in Conversations Tab)

**No message = No conversation!**

